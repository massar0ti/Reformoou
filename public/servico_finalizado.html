<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar endereço</title>
  <link rel="stylesheet" href="css/editar.css">
  <link rel="stylesheet" href="css/FONT.css">
</head>

<body>

  <div class="container">
    <h1>Detalhes do seu serviço</h1>

    <form id="editarForm">
      <div class="form-group">
        <label for="cep">Tipo de lugar:</label>
        <input type="text" id="cep" name="cep" placeholder="Digite seu CEP" maxlength="9" readonly>
      </div>

      <div class="form-group">
        <label for="rua">Ambiente:</label>
        <input type="text" id="rua" name="rua" placeholder="Digite sua rua" readonly>
      </div>

      <div class="form-group">
        <label for="numero">Descrição:</label>
        <input type="text" id="numero" name="numero" placeholder="Digite o número" readonly>
      </div>

      <div class="form-group">
        <label for="bairro">Nome do prestador:</label>
        <input type="text" id="bairro" name="bairro" placeholder="Digite seu bairro" readonly>
      </div>

      <div class="form-group">
        <label for="cidade">Valor:</label>
        <input type="text" id="cidade" name="cidade" placeholder="Digite sua cidade" readonly>
      </div>

      <div class="form-group">
        <label for="estado">Avaliação:</label>
        <input type="text" id="estado" name="estado" placeholder="Digite seu estado" readonly>
      </div>

      <a href="painel_user.html"><button type="button" class="btn-salvar" style="margin-top: 25px;">Voltar</button></a>
      <br><br>
    </form>
  </div>

  <script>
    function getQueryParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const userId = getQueryParameter('id');
      if (!userId) {
        console.error('ID do usuário não encontrado na URL');
        return;
      }
      console.log(`ID do Usuário: ${userId}`);

      // Carregar dados do endereço
      carregarDadosEndereco(userId);

      // Manipular envio do formulário para atualizar os dados
      const form = document.getElementById('editarForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault(); // Impede o envio padrão do formulário

        const rua = document.getElementById('rua').value;
        const numero = document.getElementById('numero').value;
        const cep = document.getElementById('cep').value;
        const bairro = document.getElementById('bairro').value;
        const cidade = document.getElementById('cidade').value;
        const estado = document.getElementById('estado').value;

        // Enviar dados via fetch para a API
        fetch(`http://localhost:3000/endereco/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ rua, numero, cep, bairro, cidade, estado })
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              alert('Endereço atualizado com sucesso');
              window.location.href = 'painel_user.html?id=' + userId;
            } else {
              alert('Erro ao atualizar endereço: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Erro ao enviar dados:', error);
            alert('Erro ao atualizar endereço');
          });
      });
    });

    // Função para carregar as informações do endereço
    function carregarDadosEndereco(userId) {
      fetch(`http://localhost:3000/endereco/${userId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            document.getElementById('rua').value = data.data.rua || '';
            document.getElementById('numero').value = data.data.numero || '';
            document.getElementById('cep').value = data.data.cep || '';
            document.getElementById('bairro').value = data.data.bairro || '';
            document.getElementById('cidade').value = data.data.cidade || '';
            document.getElementById('estado').value = data.data.estado || '';
          } else {
            console.error('Endereço não encontrado');
          }
        })
        .catch(error => {
          console.error('Erro ao buscar informações do endereço:', error);
        });
    }
    function aplicarMascaraCEP(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 8) value = value.slice(0, 8);
      value = value.replace(/^(\d{5})(\d)/, '$1-$2');
      input.value = value;
    }

    function formatCEP(value) {
      return value
        .replace(/\D/g, '') // Remove caracteres não numéricos
        .replace(/^(\d{5})(\d)/, '$1-$2') // Adiciona o hífen após os primeiros 5 dígitos
        .slice(0, 9); // Limita a 9 caracteres no total
    }

    async function fetchAddress(cep) {
      if (cep.length === 9) { // Confirma que o CEP está no formato correto (8 dígitos + hífen)
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        if (response.ok) {
          const address = await response.json();
          if (!address.erro) {
            document.getElementById('rua').value = address.logradouro;
            document.getElementById('bairro').value = address.bairro;
            document.getElementById('cidade').value = address.localidade;
            document.getElementById('estado').value = address.uf;
          } else {
            alert('CEP não encontrado.');
          }
        } else {
          alert('Erro ao buscar o CEP.');
        }
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      const cepInput = document.getElementById('cep');

      cepInput.addEventListener('input', (event) => {
        const formattedCEP = formatCEP(event.target.value);
        event.target.value = formattedCEP;

        // Chama a função fetchAddress se o CEP estiver completo
        if (formattedCEP.length === 9) {
          fetchAddress(formattedCEP);
        }
      });
    });
  </script>
</body>

</html>