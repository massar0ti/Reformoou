<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Cliente</title>
    <link rel="stylesheet" href="css/cadastra_cliente.css">
    <link rel="stylesheet" href="css/FONT.css">
    <style>
        .valid {
            color: green;
        }

        .invalid {
            color: red;
        }
    </style>
</head>

<body>
    <a href="index.html"><img src="imgnovas/Reformoou4.png" alt="Logo Reformoou" class="logo-reformoou"></a>
    <h1 style="margin-top: -125px; margin-bottom: 20px;">Cadastro Cliente</h1>
    <fieldset>
        <form id="cadastroForm" action="http://localhost:3000/processa_cadastro_reforma" method="post"
            onsubmit="return validarFormulario()">
            <p>Sou:
                <select id="tipo_cadastro" name="tipo_cadastro" required onchange="ajustarCampoDocumento()">
                    <option value="">Selecione</option>
                    <option value="CF">Pessoa física</option>
                    <option value="CJ">Pessoa jurídica</option>
                </select>
            </p>
            <div id="campoNome">
                <p>Nome completo: <input type="text" name="nome_completo" required></p>
            </div>
            <p>Email: <input type="text" name="email" required></p>
            <p>Telefone: <input type="text" name="telefone" oninput="aplicarMascaraTelefone(this)" maxlength="15" required></p>
            <p id="campoDocumento" style="display: none;"></p>
            <button type="button" class="btn-solicitar" onclick="verificarDocumento()">Próxima etapa</button>

            <div id="enderecoCampos" style="display:none;">
                <p>CEP: <input type="text" id="cep" name="cep" maxlength="9" placeholder="12345-678"
                        oninput="aplicarMascaraCep(this)"></p>
                <p>Rua: <input type="text" id="rua" name="rua" readonly></p>
                <p>Número: <input type="text" name="numero"></p>
                <p>Bairro: <input type="text" id="bairro" name="bairro" readonly></p>
                <p>Cidade: <input type="text" id="cidade" name="cidade" readonly></p>
                <p>Estado: <input type="text" id="estado" name="estado" readonly></p>
                <p>
                    Crie uma senha:
                    <input type="password" id="senha" name="senha" oninput="validarSenha(this)">
                </p>

                <ul id="criteria" class="criteria">
                    <li id="minimo-caracteres" class="invalid">Mínimo de 8 dígitos</li>
                    <li id="caracter-especial" class="invalid">No mínimo 1 caractere especial</li>
                    <li id="caracter-maiusculo" class="invalid">Pelo menos 1 caractere maiúsculo</li>
                    <li id="caracter-numero" class="invalid">Pelo menos 1 número</li>
                </ul>
                <button type="submit" class="btn-solicitar">Enviar</button>
            </div>
        </form>
        <p id="resultado"></p>
    </fieldset>

    <script>
        function aplicarMascaraCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length > 11) cpf = cpf.slice(0, 11);
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            return cpf;
        }

        function aplicarMascaraCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length > 14) cnpj = cnpj.slice(0, 14);
            cnpj = cnpj.replace(/^(\d{2})(\d)/, '$1.$2');
            cnpj = cnpj.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            cnpj = cnpj.replace(/\.(\d{3})(\d)/, '.$1/$2');
            cnpj = cnpj.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
            return cnpj;
        }

        function aplicarMascaraCep(cep) {
            cep.value = cep.value.replace(/\D/g, '');
            if (cep.value.length > 8) cep.value = cep.value.slice(0, 8);
            cep.value = cep.value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
        }

        function aplicarMascaraTelefone(telefone) {
    telefone.value = telefone.value.replace(/\D/g, ''); // Remove tudo que não é número

    if (telefone.value.length > 11) {
        telefone.value = telefone.value.slice(0, 11); // Limita a 11 dígitos
    }

    // Aplica a máscara para celulares com 11 dígitos: (XX) XXXXX-XXXX
    if (telefone.value.length === 11) {
        telefone.value = telefone.value.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    // Aplica a máscara para telefones fixos com 10 dígitos: (XX) XXXX-XXXX
    else if (telefone.value.length === 10) {
        telefone.value = telefone.value.replace(/^(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
}

        function ajustarCampoDocumento() {
            const campoDocumento = document.getElementById('campoDocumento');
            const tipoPessoa = document.getElementById('tipo_cadastro').value;

            campoDocumento.innerHTML = '';
            campoDocumento.style.display = 'block';

            if (tipoPessoa === "CF") {
                const labelCpf = document.createElement('label');
                labelCpf.textContent = 'CPF: ';
                const inputCpf = document.createElement('input');
                inputCpf.type = 'text';
                inputCpf.name = 'documento';
                inputCpf.id = 'documento';
                inputCpf.oninput = function () { this.value = aplicarMascaraCPF(this.value); };

                campoDocumento.appendChild(labelCpf);
                campoDocumento.appendChild(inputCpf);

            } else if (tipoPessoa === "CJ") {
                const labelCnpj = document.createElement('label');
                labelCnpj.textContent = 'CNPJ: ';
                const inputCnpj = document.createElement('input');
                inputCnpj.type = 'text';
                inputCnpj.name = 'documento';
                inputCnpj.id = 'documento';
                inputCnpj.oninput = function () { this.value = aplicarMascaraCNPJ(this.value); };

                campoDocumento.appendChild(labelCnpj);
                campoDocumento.appendChild(inputCnpj);

            } else {
                campoDocumento.style.display = 'none';
            }
        }

        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
            let soma = 0;
            for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
            let resto = soma % 11;
            let digito1 = resto < 2 ? 0 : 11 - resto;
            if (digito1 !== parseInt(cpf.charAt(9))) return false;
            soma = 0;
            for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
            resto = soma % 11;
            let digito2 = resto < 2 ? 0 : 11 - resto;
            return digito2 === parseInt(cpf.charAt(10));
        }

        function validarCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;
            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            return resultado == digitos.charAt(1);
        }

        function validarSenha(senha) {
            const minCaracteres = document.getElementById('minimo-caracteres');
            const caracterEspecial = document.getElementById('caracter-especial');
            const caracterMaiusculo = document.getElementById('caracter-maiusculo');
            const caracterNumero = document.getElementById('caracter-numero');

            // Verificação do mínimo de caracteres
            const senhaValida = senha.value.length >= 8;
            minCaracteres.classList.toggle('invalid', !senhaValida);
            minCaracteres.classList.toggle('valid', senhaValida);

            // Verificação de caractere especial
            const senhaTemEspecial = /[!@#$%^&*(),.?":{}|<>]/.test(senha.value);
            caracterEspecial.classList.toggle('invalid', !senhaTemEspecial);
            caracterEspecial.classList.toggle('valid', senhaTemEspecial);

            // Verificação de caractere maiúsculo
            const senhaTemMaiusculo = /[A-Z]/.test(senha.value);
            caracterMaiusculo.classList.toggle('invalid', !senhaTemMaiusculo);
            caracterMaiusculo.classList.toggle('valid', senhaTemMaiusculo);

            // Verificação de número
            const senhaTemNumero = /[0-9]/.test(senha.value);
            caracterNumero.classList.toggle('invalid', !senhaTemNumero);
            caracterNumero.classList.toggle('valid', senhaTemNumero);

            // A senha é válida se atender a todos os critérios
            return senhaValida && senhaTemEspecial && senhaTemMaiusculo && senhaTemNumero;
        }

        function verificarDocumento() {
            const tipoPessoa = document.getElementById('tipo_cadastro').value;
            const documento = document.getElementById('documento').value;

            if (tipoPessoa === "fisica") {
                if (!validarCPF(documento)) {
                    alert('CPF inválido.');
                    return false;
                }
            } else if (tipoPessoa === "juridica") {
                if (!validarCNPJ(documento)) {
                    alert('CNPJ inválido.');
                    return false;
                }
            }

            document.getElementById('enderecoCampos').style.display = 'block';
            return true;
        }

        function validarFormulario() {
            const senha = document.getElementById('senha');
            const senhaValida = validarSenha(senha);

            if (!senhaValida) {
                alert('A senha não atende aos requisitos.');
                return false;
            }

            return verificarDocumento(); // Verifica o CPF/CNPJ antes de permitir o envio
        }

        function buscarEndereco() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('rua').value = data.logradouro;
                            document.getElementById('bairro').value = data.bairro;
                            document.getElementById('cidade').value = data.localidade;
                            document.getElementById('estado').value = data.uf;
                        } else {
                            alert('CEP não encontrado.');
                        }
                    })
                    .catch(error => console.error('Erro:', error));
            }
        }

        document.getElementById('cep').addEventListener('blur', buscarEndereco);

        document.getElementById('form-cadastro-cliente').addEventListener('submit', async (event) => {
            event.preventDefault(); // Impede o envio do formulário padrão

            try {
                const formData = new FormData(event.target);
                const response = await fetch('/cadastrar-cliente', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // Após o cadastro, redirecione para a tela de solicitação de reforma
                    const redirectURL = localStorage.getItem('redirectAfterCadastro');
                    if (redirectURL) {
                        localStorage.removeItem('redirectAfterCadastro');
                        window.location.href = redirectURL;
                    } else {
                        window.location.href = '/solicitareformacopia.html'; // Se não houver URL, redireciona para o padrão
                    }
                } else {
                    alert('Erro ao cadastrar cliente.');
                }
            } catch (error) {
                console.error('Erro no cadastro do cliente:', error);
            }
        });
    </script>
</body>

</html>